name: Security Scanning & Vulnerability Assessment

on:
  push:
    branches: [ master, main, develop ]
  pull_request:
    branches: [ master, main, develop ]
    paths:
      - 'requirements*.txt'
      - 'pyproject.toml'
      - 'src/**'
      - 'tests/**'
  schedule:
    # Run weekly security scans
    - cron: '0 2 * * 1'  # Every Monday at 2 AM UTC
  workflow_dispatch:
    inputs:
      scan_type:
        description: 'Security scan type (full, dependencies, code, secrets)'
        required: false
        default: 'full'

env:
  PYTHONUNBUFFERED: 1

jobs:
  # ====================================================================
  # DEPENDENCY VULNERABILITY SCANNING
  # ====================================================================

  dependency-security:
    name: Dependency Vulnerability Scan
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.12"
        cache: 'pip'

    - name: Cache security tools
      uses: actions/cache@v4
      with:
        path: |
          ~/.cache/pip
          ~/.local/share/safety
        key: ${{ runner.os }}-security-tools-${{ hashFiles('requirements*.txt') }}
        restore-keys: |
          ${{ runner.os }}-security-tools-

    - name: Install security scanning tools
      run: |
        python -m pip install --upgrade pip
        pip install safety bandit[toml] pip-audit licensecheck pip-licenses
        pip install semgrep trufflehog3  # Advanced security tools

    # ====================================================================
    # VULNERABILITY DATABASE CHECKS
    # ====================================================================

    - name: Check Safety (known vulnerabilities)
      run: |
        echo "ğŸ” Scanning for known security vulnerabilities..."

        # Scan production dependencies
        if safety check --file requirements.txt --output json > safety-prod-results.json 2>/dev/null; then
          vuln_count=$(python -c "
          import json
          try:
              with open('safety-prod-results.json') as f:
                  data = json.load(f)
              print(len(data.get('vulnerabilities', [])))
          except:
              print('0')
          ")
          echo "Production dependencies: $vuln_count vulnerabilities found"
        else
          echo "âŒ Safety scan failed for production dependencies"
        fi

        # Scan development dependencies
        if safety check --file requirements-dev.txt --output json > safety-dev-results.json 2>/dev/null; then
          dev_vuln_count=$(python -c "
          import json
          try:
              with open('safety-dev-results.json') as f:
                  data = json.load(f)
              print(len(data.get('vulnerabilities', [])))
          except:
              print('0')
          ")
          echo "Development dependencies: $dev_vuln_count vulnerabilities found"
        else
          echo "âŒ Safety scan failed for development dependencies"
        fi

    - name: Advanced dependency audit with pip-audit
      run: |
        echo "ğŸ“Š Running advanced dependency audit..."

        if pip-audit --format json > pip-audit-results.json 2>/dev/null; then
          audit_issues=$(python -c "
          import json
          try:
              with open('pip-audit-results.json') as f:
                  data = json.load(f)
              print(len(data))
          except:
              print('0')
          ")
          echo "pip-audit found $audit_issues issues"
        else
          echo "âŒ pip-audit failed"
        fi

    # ====================================================================
    # CODE SECURITY ANALYSIS
    # ====================================================================

    - name: Run Bandit security linter
      run: |
        echo "ğŸ›¡ï¸ Running Bandit security analysis..."

        # Run comprehensive Bandit scan
        python -m bandit -r src/ \
          -f json \
          -o bandit-results.json \
          --configfile pyproject.toml \
          --baseline bandit-baseline.json \
          --verbose

        # Analyze results
        high_sev=$(python -c "
        import json
        try:
            with open('bandit-results.json') as f:
                data = json.load(f)
            high_count = sum(1 for result in data.get('results', {}).values()
                           for issue in result
                           if issue.get('issue_severity') == 'high')
            print(high_count)
        except:
            print('0')
        ")

        medium_sev=$(python -c "
        import json
        try:
            with open('bandit-results.json') as f:
                data = json.load(f)
            medium_count = sum(1 for result in data.get('results', {}).values()
                             for issue in result
                             if issue.get('issue_severity') == 'medium')
            print(medium_count)
        except:
            print('0')
        ")

        echo "Bandit results: $high_sev high severity, $medium_sev medium severity"

    - name: Run Semgrep security analysis
      run: |
        echo "ğŸ”¬ Running Semgrep security analysis..."

        # Install Semgrep rules for Python
        if command -v semgrep >/dev/null 2>&1; then
          semgrep --config auto \
            --json \
            --output semgrep-results.json \
            src/ || true

          semgrep_issues=$(python -c "
          import json
          try:
              with open('semgrep-results.json') as f:
                  data = json.load(f)
              print(len(data.get('results', [])))
          except:
              print('0')
          ")
          echo "Semgrep found $semgrep_issues potential issues"
        else
          echo "âš ï¸ Semgrep not available - install with: pip install semgrep"
        fi

    # ====================================================================
    # LICENSE COMPLIANCE
    # ====================================================================

    - name: Check license compliance
      run: |
        echo "ğŸ“„ Checking license compliance..."

        if python -c "
        import subprocess
        try:
            result = subprocess.run(['pip-licenses'], capture_output=True, text=True)
            if result.returncode == 0:
                lines = result.stdout.strip().split('\n')
                unknown_count = sum(1 for line in lines if 'UNKNOWN' in line.upper())
                print(f'Found {unknown_count} packages with unknown licenses')
                if unknown_count > 0:
                    print('Packages with unknown licenses:')
                    for line in lines:
                        if 'UNKNOWN' in line.upper():
                            print(f'  {line}')
            else:
                print('pip-licenses command failed')
        except Exception as e:
            print(f'License check error: {e}')
        "; then
          echo "âœ… License compliance check completed"
        else
          echo "âŒ License compliance check failed"
        fi

    # ====================================================================
    # SECRETS DETECTION
    # ====================================================================

    - name: Check for exposed secrets
      run: |
        echo "ğŸ”‘ Checking for exposed secrets and sensitive data..."

        # Check for common secret patterns
        secret_patterns=(
          "password|passwd|pwd"
          "secret|token|key|apikey"
          "aws_access_key|aws_secret"
          "database_url|db_url"
          "private_key|secret_key"
        )

        secret_found=false

        for pattern in "${secret_patterns[@]}"; do
          if grep -r -i "$pattern" src/ --include="*.py" | grep -v "#\|//\|\"\"\".*\"\"\"\|'''.*'''" | grep -v "example\|test\|mock\|fake"; then
            echo "âš ï¸ Potential sensitive data pattern found: $pattern"
            secret_found=true
          fi
        done

        if [[ "$secret_found" == "false" ]]; then
          echo "âœ… No obvious secrets or sensitive data patterns found"
        else
          echo "âš ï¸ Potential sensitive data patterns detected - review manually"
        fi

    - name: Run TruffleHog secrets detection
      run: |
        echo "ğŸ•µï¸ Running TruffleHog secrets detection..."

        if command -v trufflehog3 >/dev/null 2>&1; then
          trufflehog3 filesystem src/ --json > trufflehog-results.json 2>/dev/null || true

          secrets_found=$(python -c "
          import json
          try:
              with open('trufflehog-results.json') as f:
                  data = json.load(f)
              print(len(data))
          except:
              print('0')
          ")
          echo "TruffleHog found $secrets_found potential secrets"
        else
          echo "âš ï¸ TruffleHog not available - install with: pip install trufflehog3"
        fi

    # ====================================================================
    # DEPENDENCY ANALYSIS
    # ====================================================================

    - name: Analyze dependency tree
      run: |
        echo "ğŸŒ³ Analyzing dependency tree for security issues..."

        # Generate dependency tree
        pip install pipdeptree
        pipdeptree --json > dependency-tree.json 2>/dev/null || echo "[]" > dependency-tree.json

        # Check for problematic packages
        problematic_packages=(
          "insecure-package"
          "vulnerable-lib"
        )

        found_problematic=false
        for pkg in "${problematic_packages[@]}"; do
          if pip list | grep -i "$pkg" >/dev/null; then
            echo "âš ï¸ Potentially problematic package found: $pkg"
            found_problematic=true
          fi
        done

        if [[ "$found_problematic" == "false" ]]; then
          echo "âœ… No known problematic packages found"
        fi

    # ====================================================================
    # SECURITY SCORE CALCULATION
    # ====================================================================

    - name: Calculate security score
      run: |
        echo "ğŸ“Š Calculating security score..."

        score=100

        # Deduct points for various issues
        if [[ -f "safety-prod-results.json" ]]; then
          vuln_count=$(python -c "
          import json
          try:
              with open('safety-prod-results.json') as f:
                  data = json.load(f)
              print(len(data.get('vulnerabilities', [])))
          except:
              print('0')
          ")
          score=$((score - vuln_count * 5))  # -5 points per vulnerability
        fi

        # Bandit high severity issues
        if [[ -f "bandit-results.json" ]]; then
          high_count=$(python -c "
          import json
          try:
              with open('bandit-results.json') as f:
                  data = json.load(f)
              high_count = sum(1 for result in data.get('results', {}).values()
                             for issue in result
                             if issue.get('issue_severity') == 'high')
              print(high_count)
          except:
              print('0')
          ")
          score=$((score - high_count * 10))  # -10 points per high severity issue
        fi

        # Ensure score doesn't go below 0
        if [[ $score -lt 0 ]]; then
          score=0
        fi

        echo "Security Score: $score/100"

        # Determine rating
        if [[ $score -ge 90 ]]; then
          echo "Security Rating: ğŸŸ¢ EXCELLENT"
        elif [[ $score -ge 75 ]]; then
          echo "Security Rating: ğŸŸ¡ GOOD"
        elif [[ $score -ge 60 ]]; then
          echo "Security Rating: ğŸŸ  FAIR"
        else
          echo "Security Rating: ğŸ”´ POOR"
        fi

        # Output score for other jobs
        echo "score=$score" >> $GITHUB_OUTPUT

    - name: Upload security scan results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: security-scan-results-${{ github.run_id }}
        path: |
          safety-prod-results.json
          safety-dev-results.json
          pip-audit-results.json
          bandit-results.json
          semgrep-results.json
          trufflehog-results.json
          dependency-tree.json

    # ====================================================================
    # SARIF REPORT FOR GITHUB SECURITY TAB
    # ====================================================================

    - name: Generate SARIF report for GitHub Security tab
      run: |
        echo "ğŸ“‹ Generating SARIF report for GitHub Security tab..."

        # Convert Bandit results to SARIF format for GitHub Security tab
        python -c "
        import json
        import os

        sarif = {
            '\$schema': 'https://raw.githubusercontent.com/oasis-tcs/sarif-spec/master/Schemata/sarif-schema-2.1.0.json',
            'version': '2.1.0',
            'runs': [{
                'tool': {
                    'driver': {
                        'name': 'Bandit',
                        'informationUri': 'https://bandit.readthedocs.io/',
                        'rules': []
                    }
                },
                'results': []
            }]
        }

        try:
            with open('bandit-results.json') as f:
                bandit_data = json.load(f)

            for filename, issues in bandit_data.get('results', {}).items():
                for issue in issues:
                    result = {
                        'ruleId': issue.get('test_id', 'unknown'),
                        'level': 'warning' if issue.get('issue_severity') == 'medium' else 'error',
                        'message': {
                            'text': issue.get('issue_text', 'Security issue found')
                        },
                        'locations': [{
                            'physicalLocation': {
                                'artifactLocation': {
                                    'uri': filename
                                },
                                'region': {
                                    'startLine': issue.get('line_number', 1)
                                }
                            }
                        }]
                    }
                    sarif['runs'][0]['results'].append(result)

            with open('security-results.sarif', 'w') as f:
                json.dump(sarif, f, indent=2)

            print('SARIF report generated: security-results.sarif')

        except Exception as e:
            print(f'Error generating SARIF report: {e}')
            # Create minimal valid SARIF
            with open('security-results.sarif', 'w') as f:
                json.dump(sarif, f, indent=2)
        "

    - name: Upload SARIF report to GitHub Security tab
      uses: github/codeql-action/upload-sarif@v3
      if: always()
      with:
        sarif_file: security-results.sarif
        category: security-scan

  # ====================================================================
  # DEPENDABOT COMPATIBILITY CHECK
  # ====================================================================

  dependabot-check:
    name: Dependabot Compatibility
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Check Dependabot PR
      run: |
        if [[ "${{ github.actor }}" == "dependabot[bot]" ]]; then
          echo "ğŸ¤– Dependabot PR detected - running compatibility checks..."

          # Check if requirements files are valid after Dependabot changes
          python -c "
          import pkg_resources
          import sys

          try:
              # Try to parse all requirements
              with open('requirements.txt') as f:
                  for line in f:
                      line = line.strip()
                      if line and not line.startswith('#'):
                          pkg_resources.Requirement.parse(line)
              print('âœ… requirements.txt syntax valid')
          except Exception as e:
              print(f'âŒ requirements.txt syntax error: {e}')
              sys.exit(1)
          "

          # Run basic import test
          python -c "
          import sys
          sys.path.insert(0, 'src')
          import config, data, content, plots, logger, accessibility
          print('âœ… Module imports work with updated dependencies')
          "

        else
          echo "â„¹ï¸ Not a Dependabot PR - skipping compatibility check"
        fi

  # ====================================================================
  # SECURITY SUMMARY & REPORTING
  # ====================================================================

  security-summary:
    name: Security Assessment Summary
    runs-on: ubuntu-latest
    needs: [dependency-security, dependabot-check]
    if: always()

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download security artifacts
      uses: actions/download-artifact@v4
      with:
        path: security-artifacts/

    - name: Generate security assessment report
      run: |
        echo "# ğŸ”’ Linear Regression Guide - Security Assessment Report" > security-assessment-report.md
        echo "" >> security-assessment-report.md
        echo "## Executive Summary" >> security-assessment-report.md
        echo "" >> security-assessment-report.md
        echo "This report summarizes the security assessment performed on the Linear Regression Guide project." >> security-assessment-report.md
        echo "" >> security-assessment-report.md

        echo "## Assessment Details" >> security-assessment-report.md
        echo "- **Generated**: $(date)" >> security-assessment-report.md
        echo "- **Workflow**: ${{ github.workflow }}" >> security-assessment-report.md
        echo "- **Repository**: ${{ github.repository }}" >> security-assessment-report.md
        echo "- **Branch**: ${{ github.ref_name }}" >> security-assessment-report.md
        echo "- **Commit**: ${{ github.sha }}" >> security-assessment-report.md
        echo "- **Trigger**: ${{ github.event_name }}" >> security-assessment-report.md
        echo "" >> security-assessment-report.md

        echo "## Security Scan Results" >> security-assessment-report.md
        echo "" >> security-assessment-report.md

        # Vulnerability Assessment
        echo "### ğŸ” Vulnerability Assessment" >> security-assessment-report.md

        if [[ -f "security-artifacts/security-scan-results-${{ github.run_id }}/safety-prod-results.json" ]]; then
          vuln_count=$(python -c "
          import json, os
          try:
              with open('security-artifacts/security-scan-results-${{ github.run_id }}/safety-prod-results.json') as f:
                  data = json.load(f)
              print(len(data.get('vulnerabilities', [])))
          except:
              print('unknown')
          ")
          echo "- **Known Vulnerabilities**: $vuln_count found in production dependencies" >> security-assessment-report.md
        else
          echo "- **Known Vulnerabilities**: Scan not completed" >> security-assessment-report.md
        fi

        # Code Security
        echo "" >> security-assessment-report.md
        echo "### ğŸ›¡ï¸ Code Security Analysis" >> security-assessment-report.md

        if [[ -f "security-artifacts/security-scan-results-${{ github.run_id }}/bandit-results.json" ]]; then
          high_count=$(python -c "
          import json
          try:
              with open('security-artifacts/security-scan-results-${{ github.run_id }}/bandit-results.json') as f:
                  data = json.load(f)
              high_count = sum(1 for result in data.get('results', {}).values()
                             for issue in result
                             if issue.get('issue_severity') == 'high')
              print(high_count)
          except:
              print('unknown')
          ")
          echo "- **High Severity Issues**: $high_count found in codebase" >> security-assessment-report.md
        else
          echo "- **High Severity Issues**: Scan not completed" >> security-assessment-report.md
        fi

        # Overall Assessment
        echo "" >> security-assessment-report.md
        echo "## Security Assessment" >> security-assessment-report.md
        echo "" >> security-assessment-report.md

        # Determine overall status
        critical_issues=0

        # Count critical issues
        if [[ "$vuln_count" != "0" ]] && [[ "$vuln_count" != "unknown" ]]; then
          critical_issues=$((critical_issues + 1))
        fi

        if [[ "$high_count" != "0" ]] && [[ "$high_count" != "unknown" ]]; then
          critical_issues=$((critical_issues + 1))
        fi

        if [[ $critical_issues -eq 0 ]]; then
          echo "### ğŸŸ¢ SECURITY STATUS: SECURE" >> security-assessment-report.md
          echo "" >> security-assessment-report.md
          echo "No critical security issues were identified. The codebase appears to be secure." >> security-assessment-report.md
          echo "" >> security-assessment-report.md
          echo "#### Recommendations:" >> security-assessment-report.md
          echo "- Continue regular security scans" >> security-assessment-report.md
          echo "- Keep dependencies updated" >> security-assessment-report.md
          echo "- Monitor for new security advisories" >> security-assessment-report.md
        else
          echo "### ğŸ”´ SECURITY STATUS: ISSUES FOUND" >> security-assessment-report.md
          echo "" >> security-assessment-report.md
          echo "$critical_issues critical security issue(s) were identified. Review the detailed scan results." >> security-assessment-report.md
          echo "" >> security-assessment-report.md
          echo "#### Required Actions:" >> security-assessment-report.md
          echo "- Review detailed security scan reports" >> security-assessment-report.md
          echo "- Address high-severity security issues" >> security-assessment-report.md
          echo "- Update vulnerable dependencies" >> security-assessment-report.md
          echo "- Re-run security scans after fixes" >> security-assessment-report.md
        fi

        echo "" >> security-assessment-report.md
        echo "## Detailed Reports" >> security-assessment-report.md
        echo "" >> security-assessment-report.md
        echo "Detailed security scan results are available in the workflow artifacts:" >> security-assessment-report.md
        echo "- \`safety-prod-results.json\` - Known vulnerability scan results" >> security-assessment-report.md
        echo "- \`bandit-results.json\` - Code security analysis results" >> security-assessment-report.md
        echo "- \`pip-audit-results.json\` - Advanced dependency audit" >> security-assessment-report.md
        echo "- \`semgrep-results.json\` - Semantic code analysis" >> security-assessment-report.md
        echo "- \`trufflehog-results.json\` - Secrets detection results" >> security-assessment-report.md
        echo "" >> security-assessment-report.md

        echo "---" >> security-assessment-report.md
        echo "*This report was automatically generated by the Security Scanning workflow*" >> security-assessment-report.md

    - name: Upload security assessment report
      uses: actions/upload-artifact@v4
      with:
        name: security-assessment-report
        path: security-assessment-report.md

    - name: Security scan completion notification
      if: always()
      run: |
        echo "ğŸ”’ Security scanning completed!"

        if [[ "${{ needs.dependency-security.result }}" == "success" ]]; then
          echo "âœ… Security scans completed successfully"
        else
          echo "âš ï¸ Security scans completed with issues - review the assessment report"
        fi