name: Deployment Readiness & Security Validation

on:
  push:
    branches: [ master, main, develop ]
  pull_request:
    branches: [ master, main, develop ]
    types: [opened, synchronize, reopened, ready_for_review]
  workflow_dispatch:
    inputs:
      deployment_target:
        description: 'Deployment target (streamlit-cloud, heroku, vercel, etc.)'
        required: false
        default: 'streamlit-cloud'

env:
  PYTHONUNBUFFERED: 1
  PYTHONDONTWRITEBYTECODE: 1

jobs:
  # ====================================================================
  # BASIC DEPLOYMENT READINESS
  # ====================================================================

  deployment-readiness:
    name: Deployment Readiness Check
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: read

    outputs:
      deployment_ready: ${{ steps.deployment-check.outputs.ready }}
      security_issues: ${{ steps.security-scan.outputs.issues }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.12"
        cache: 'pip'

    - name: Install basic dependencies
      run: |
        python -m pip install --upgrade pip setuptools wheel
        pip install -r requirements.txt

    # ====================================================================
    # FILE STRUCTURE VALIDATION
    # ====================================================================

    - name: Validate project structure
      run: |
        echo "üìÅ Validating project structure..."

        # Required files for deployment
        required_files=(
          "run.py"
          "src/app.py"
          "src/config.py"
          "src/data.py"
          "src/content.py"
          "src/plots.py"
          "src/logger.py"
          "src/accessibility.py"
          "requirements.txt"
          ".streamlit/config.toml"
          "README.md"
        )

        missing_files=()
        for file in "${required_files[@]}"; do
          if [[ ! -f "$file" ]]; then
            missing_files+=("$file")
            echo "‚ùå Missing: $file"
          else
            echo "‚úÖ Found: $file"
          fi
        done

        if [[ ${#missing_files[@]} -gt 0 ]]; then
          echo "‚ùå Missing required files: ${missing_files[*]}"
          exit 1
        fi

        echo "‚úÖ All required files present"

    # ====================================================================
    # PYTHON COMPATIBILITY & SYNTAX
    # ====================================================================

    - name: Check Python syntax and compilation
      run: |
        echo "üêç Checking Python syntax and compilation..."

        # Files to check
        python_files=(
          "run.py"
          "src/app.py"
          "src/config.py"
          "src/data.py"
          "src/content.py"
          "src/plots.py"
          "src/logger.py"
          "src/accessibility.py"
        )

        for file in "${python_files[@]}"; do
          if [[ -f "$file" ]]; then
            if python -m py_compile "$file"; then
              echo "‚úÖ $file compiles successfully"
            else
              echo "‚ùå $file has syntax errors"
              exit 1
            fi
          fi
        done

        echo "‚úÖ All Python files compile successfully"

    # ====================================================================
    # DEPENDENCY VALIDATION
    # ====================================================================

    - name: Validate dependencies
      run: |
        echo "üì¶ Validating dependencies..."

        # Check requirements.txt format
        if [[ ! -f "requirements.txt" ]]; then
          echo "‚ùå requirements.txt not found"
          exit 1
        fi

        # Validate package format
        while IFS= read -r line; do
          # Skip comments and empty lines
          [[ $line =~ ^[[:space:]]*# ]] && continue
          [[ -z "$line" ]] && continue

          # Basic package name validation
          if [[ ! $line =~ ^[a-zA-Z0-9_-]+ ]]; then
            echo "‚ùå Invalid package format in requirements.txt: $line"
            exit 1
          fi
        done < requirements.txt

        echo "‚úÖ requirements.txt format is valid"

        # Check for core dependencies
        core_deps=("streamlit" "numpy" "pandas" "plotly" "statsmodels" "scipy")
        for dep in "${core_deps[@]}"; do
          if grep -q "^${dep}" requirements.txt; then
            echo "‚úÖ Core dependency found: $dep"
          else
            echo "‚ùå Missing core dependency: $dep"
            exit 1
          fi
        done

    # ====================================================================
    # MODULE IMPORT VALIDATION
    # ====================================================================

    - name: Validate module imports
      run: |
        echo "üîó Validating module imports..."

        # Test all module imports
        modules=("config" "data" "content" "plots" "logger" "accessibility")

        for module in "${modules[@]}"; do
          if python -c "
          import sys
          sys.path.insert(0, 'src')
          import $module
          print('Import successful')
          " 2>/dev/null; then
            echo "‚úÖ $module module imports successfully"
          else
            echo "‚ùå $module module import failed"
            exit 1
          fi
        done

        echo "‚úÖ All modules import successfully"

    # ====================================================================
    # STREAMLIT CONFIGURATION VALIDATION
    # ====================================================================

    - name: Validate Streamlit configuration
      run: |
        echo "üåê Validating Streamlit configuration..."

        config_file=".streamlit/config.toml"
        if [[ ! -f "$config_file" ]]; then
          echo "‚ùå Streamlit config file not found: $config_file"
          exit 1
        fi

        # Basic TOML validation
        if python -c "
        import tomllib
        with open('$config_file', 'rb') as f:
            config = tomllib.load(f)
        print('TOML syntax is valid')
        required_keys = ['global', 'server']
        for key in required_keys:
            if key not in config:
                print(f'Missing required section: {key}')
                exit(1)
        " 2>/dev/null; then
          echo "‚úÖ Streamlit configuration is valid"
        else
          echo "‚ùå Streamlit configuration validation failed"
          exit 1
        fi

    # ====================================================================
    # BASIC FUNCTIONALITY TEST
    # ====================================================================

    - name: Test basic functionality
      run: |
        echo "‚ö° Testing basic functionality..."

        # Test data generation
        if python -c "
        import sys
        sys.path.insert(0, 'src')
        from data import generate_simple_regression_data
        result = generate_simple_regression_data('üá®üá≠ Schweizer Kantone (sozio√∂konomisch)', 'Population Density', 5, 42)
        assert 'x' in result and 'y' in result and len(result['x']) == 5
        print('Data generation works')
        "; then
          echo "‚úÖ Data generation functionality verified"
        else
          echo "‚ùå Data generation functionality failed"
          exit 1
        fi

        # Test content generation
        if python -c "
        import sys
        sys.path.insert(0, 'src')
        from content import get_simple_regression_content
        content = get_simple_regression_content('üá®üá≠ Schweizer Kantone (sozio√∂konomisch)', 'Population Density')
        assert 'context_title' in content
        print('Content generation works')
        "; then
          echo "‚úÖ Content generation functionality verified"
        else
          echo "‚ùå Content generation functionality failed"
          exit 1
        fi

        echo "‚úÖ Basic functionality tests passed"

    - name: Set deployment readiness
      id: deployment-check
      run: |
        echo "ready=true" >> $GITHUB_OUTPUT
        echo "‚úÖ Deployment readiness check completed"

  # ====================================================================
  # SECURITY SCANNING
  # ====================================================================

  security-scan:
    name: Security Vulnerability Scan
    runs-on: ubuntu-latest
    needs: deployment-readiness
    permissions:
      contents: read
      security-events: write

    outputs:
      vulnerabilities_found: ${{ steps.security-check.outputs.found }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.12"
        cache: 'pip'

    - name: Install security scanning tools
      run: |
        python -m pip install --upgrade pip
        pip install safety bandit[toml] pip-audit

    - name: Run security vulnerability checks
      id: security-check
      run: |
        echo "üîí Running security vulnerability scans..."

        vulnerabilities_found=false

        # Check for known security vulnerabilities
        echo "Checking Safety (known vulnerabilities)..."
        if safety check --file requirements.txt --output json > safety-results.json 2>/dev/null; then
          vuln_count=$(python -c "
          import json
          with open('safety-results.json') as f:
              data = json.load(f)
          print(len(data.get('vulnerabilities', [])))
          ")
          if [[ "$vuln_count" -gt 0 ]]; then
            echo "‚ö†Ô∏è Safety found $vuln_count vulnerabilities"
            vulnerabilities_found=true
          else
            echo "‚úÖ No known vulnerabilities found by Safety"
          fi
        else
          echo "‚ö†Ô∏è Safety check failed or found issues"
          vulnerabilities_found=true
        fi

        # Run Bandit security linter
        echo "Checking Bandit (security anti-patterns)..."
        if python -m bandit -r src/ -f json -o bandit-results.json --quiet; then
          high_sev=$(python -c "
          import json
          with open('bandit-results.json') as f:
              data = json.load(f)
          high_count = sum(1 for issue in data.get('results', []) if issue.get('issue_severity') == 'high')
          print(high_count)
          ")
          if [[ "$high_sev" -gt 0 ]]; then
            echo "‚ö†Ô∏è Bandit found $high_sev high-severity security issues"
            vulnerabilities_found=true
          else
            echo "‚úÖ No high-severity security issues found by Bandit"
          fi
        else
          echo "‚ö†Ô∏è Bandit check failed"
          vulnerabilities_found=true
        fi

        # Output result for next jobs
        echo "found=$vulnerabilities_found" >> $GITHUB_OUTPUT

        if [[ "$vulnerabilities_found" == "true" ]]; then
          echo "‚ö†Ô∏è Security issues found - review reports"
        else
          echo "‚úÖ No critical security issues found"
        fi

    - name: Upload security scan results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: security-scan-results
        path: |
          safety-results.json
          bandit-results.json

  # ====================================================================
  # DEPLOYMENT TARGET SPECIFIC VALIDATION
  # ====================================================================

  deployment-target-validation:
    name: Deployment Target Validation
    runs-on: ubuntu-latest
    needs: [deployment-readiness, security-scan]
    if: github.event_name == 'workflow_dispatch'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Validate for ${{ github.event.inputs.deployment_target }}
      run: |
        target="${{ github.event.inputs.deployment_target }}"
        echo "üéØ Validating deployment for target: $target"

        case "$target" in
          "streamlit-cloud")
            echo "Validating Streamlit Cloud requirements..."
            # Check file size limits
            main_file_size=$(stat -c%s run.py 2>/dev/null || stat -f%z run.py 2>/dev/null || echo "0")
            if [[ $main_file_size -gt 10485760 ]]; then  # 10MB
              echo "‚ùå Main file too large for Streamlit Cloud (10MB limit)"
              exit 1
            fi
            echo "‚úÖ File sizes within Streamlit Cloud limits"
            ;;

          "heroku")
            echo "Validating Heroku requirements..."
            if [[ ! -f "Procfile" ]]; then
              echo "‚ö†Ô∏è Procfile not found - Heroku deployment may need manual setup"
            fi
            echo "‚úÖ Basic Heroku validation completed"
            ;;

          "vercel")
            echo "Validating Vercel requirements..."
            if [[ ! -f "vercel.json" ]] && [[ ! -f "package.json" ]]; then
              echo "‚ö†Ô∏è No Vercel configuration found"
            fi
            echo "‚úÖ Basic Vercel validation completed"
            ;;

          *)
            echo "‚ÑπÔ∏è Generic deployment validation for target: $target"
            ;;
        esac

        echo "‚úÖ Deployment target validation completed"

  # ====================================================================
  # COMPREHENSIVE DEPLOYMENT REPORT
  # ====================================================================

  deployment-report:
    name: Deployment Readiness Report
    runs-on: ubuntu-latest
    needs: [deployment-readiness, security-scan, deployment-target-validation]
    if: always()

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download validation artifacts
      uses: actions/download-artifact@v4
      with:
        path: validation-artifacts/

    - name: Generate deployment readiness report
      run: |
        echo "# üöÄ Linear Regression Guide - Deployment Readiness Report" > deployment-readiness-report.md
        echo "" >> deployment-readiness-report.md
        echo "## Executive Summary" >> deployment-readiness-report.md
        echo "" >> deployment-readiness-report.md
        echo "This report validates the deployment readiness of the Linear Regression Guide application." >> deployment-readiness-report.md
        echo "" >> deployment-readiness-report.md

        echo "## Report Details" >> deployment-readiness-report.md
        echo "- **Generated**: $(date)" >> deployment-readiness-report.md
        echo "- **Workflow**: ${{ github.workflow }}" >> deployment-readiness-report.md
        echo "- **Repository**: ${{ github.repository }}" >> deployment-readiness-report.md
        echo "- **Branch**: ${{ github.ref_name }}" >> deployment-readiness-report.md
        echo "- **Commit**: ${{ github.sha }}" >> deployment-readiness-report.md
        echo "- **Deployment Target**: ${{ github.event.inputs.deployment_target || 'streamlit-cloud' }}" >> deployment-readiness-report.md
        echo "" >> deployment-readiness-report.md

        echo "## Validation Results" >> deployment-readiness-report.md
        echo "" >> deployment-readiness-report.md

        # Basic readiness
        if [[ "${{ needs.deployment-readiness.result }}" == "success" ]]; then
          echo "### ‚úÖ Basic Deployment Readiness" >> deployment-readiness-report.md
          echo "- Project structure validated" >> deployment-readiness-report.md
          echo "- Python syntax verified" >> deployment-readiness-report.md
          echo "- Dependencies validated" >> deployment-readiness-report.md
          echo "- Module imports confirmed" >> deployment-readiness-report.md
          echo "- Basic functionality tested" >> deployment-readiness-report.md
        else
          echo "### ‚ùå Basic Deployment Readiness" >> deployment-readiness-report.md
          echo "- Issues found in basic validation" >> deployment-readiness-report.md
        fi
        echo "" >> deployment-readiness-report.md

        # Security assessment
        if [[ "${{ needs.security-scan.outputs.vulnerabilities_found }}" == "false" ]]; then
          echo "### ‚úÖ Security Assessment" >> deployment-readiness-report.md
          echo "- No critical security vulnerabilities found" >> deployment-readiness-report.md
          echo "- Security scanning completed successfully" >> deployment-readiness-report.md
        else
          echo "### ‚ö†Ô∏è Security Assessment" >> deployment-readiness-report.md
          echo "- Security vulnerabilities detected" >> deployment-readiness-report.md
          echo "- Review security scan reports before deployment" >> deployment-readiness-report.md
        fi
        echo "" >> deployment-readiness-report.md

        # Overall assessment
        echo "## Deployment Recommendation" >> deployment-readiness-report.md
        echo "" >> deployment-readiness-report.md

        if [[ "${{ needs.deployment-readiness.result }}" == "success" ]] && \
           [[ "${{ needs.security-scan.outputs.vulnerabilities_found }}" != "true" ]]; then

          echo "### üéâ DEPLOYMENT APPROVED" >> deployment-readiness-report.md
          echo "" >> deployment-readiness-report.md
          echo "The application has passed all deployment readiness checks and is approved for deployment." >> deployment-readiness-report.md
          echo "" >> deployment-readiness-report.md
          echo "#### Next Steps:" >> deployment-readiness-report.md
          echo "1. **Deploy to Streamlit Cloud**:" >> deployment-readiness-report.md
          echo "   - Visit: https://share.streamlit.io" >> deployment-readiness-report.md
          echo "   - Connect your GitHub repository" >> deployment-readiness-report.md
          echo "   - Set main file path to: \`run.py\`" >> deployment-readiness-report.md
          echo "   - Click 'Deploy'" >> deployment-readiness-report.md
          echo "" >> deployment-readiness-report.md
          echo "2. **Post-Deployment**:" >> deployment-readiness-report.md
          echo "   - Update README.md with live demo link" >> deployment-readiness-report.md
          echo "   - Monitor application performance" >> deployment-readiness-report.md
          echo "   - Set up monitoring and alerts" >> deployment-readiness-report.md
          echo "" >> deployment-readiness-report.md
          echo "3. **Maintenance**:" >> deployment-readiness-report.md
          echo "   - Keep dependencies updated" >> deployment-readiness-report.md
          echo "   - Monitor security advisories" >> deployment-readiness-report.md
          echo "   - Regular code quality checks" >> deployment-readiness-report.md

        else
          echo "### ‚ùå DEPLOYMENT NOT RECOMMENDED" >> deployment-readiness-report.md
          echo "" >> deployment-readiness-report.md
          echo "Issues were found during validation. Please address the following:" >> deployment-readiness-report.md
          echo "" >> deployment-readiness-report.md
          echo "#### Required Actions:" >> deployment-readiness-report.md
          if [[ "${{ needs.deployment-readiness.result }}" != "success" ]]; then
            echo "- Fix basic deployment readiness issues" >> deployment-readiness-report.md
          fi
          if [[ "${{ needs.security-scan.outputs.vulnerabilities_found }}" == "true" ]]; then
            echo "- Address security vulnerabilities" >> deployment-readiness-report.md
          fi
          echo "- Re-run deployment validation" >> deployment-readiness-report.md
          echo "- Ensure all checks pass before deployment" >> deployment-readiness-report.md
        fi

        echo "" >> deployment-readiness-report.md
        echo "---" >> deployment-readiness-report.md
        echo "*This report was automatically generated by GitHub Actions deployment validation workflow*" >> deployment-readiness-report.md

    - name: Upload deployment readiness report
      uses: actions/upload-artifact@v4
      with:
        name: deployment-readiness-report
        path: deployment-readiness-report.md

    - name: Deployment validation summary
      if: always()
      run: |
        echo "üìã Deployment Validation Summary:"
        echo "  ‚Ä¢ Basic Readiness: ${{ needs.deployment-readiness.result }}"
        echo "  ‚Ä¢ Security Scan: ${{ needs.security-scan.result }}"
        echo "  ‚Ä¢ Target Validation: ${{ needs.deployment-target-validation.result }}"

        if [[ "${{ needs.deployment-readiness.result }}" == "success" ]] && \
           [[ "${{ needs.security-scan.outputs.vulnerabilities_found }}" != "true" ]]; then
          echo ""
          echo "üéâ DEPLOYMENT READY! The application has passed all validation checks."
          echo ""
          echo "üöÄ Ready to deploy to: ${{ github.event.inputs.deployment_target || 'streamlit-cloud' }}"
        else
          echo ""
          echo "‚ö†Ô∏è DEPLOYMENT BLOCKED: Issues found during validation."
          echo "   Please review the deployment readiness report for details."
        fi
