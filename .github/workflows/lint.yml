name: Code Quality & Security Checks

on:
  push:
    branches: [ master, main, develop ]
  pull_request:
    branches: [ master, main, develop ]
  workflow_dispatch:
    inputs:
      check_types:
        description: 'Check types to run (comma-separated: format,lint,type,security,docs)'
        required: false
        default: 'format,lint,type,security'

env:
  PYTHONUNBUFFERED: 1
  PYTHONDONTWRITEBYTECODE: 1

jobs:
  # ====================================================================
  # CODE FORMATTING & STYLE CHECKS
  # ====================================================================

  code-quality:
    name: Code Quality Checks (Python ${{ matrix.python-version }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.9", "3.11", "3.12"]
        include:
          - python-version: "3.12"
            is_main: true

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
        cache: 'pip'

    - name: Cache pre-commit environment
      uses: actions/cache@v4
      with:
        path: ~/.cache/pre-commit
        key: ${{ runner.os }}-pre-commit-${{ matrix.python-version }}-${{ hashFiles('.pre-commit-config.yaml') }}
        restore-keys: |
          ${{ runner.os }}-pre-commit-${{ matrix.python-version }}-
          ${{ runner.os }}-pre-commit-

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y shellcheck

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip setuptools wheel
        pip install -r requirements.txt -r requirements-dev.txt
        pip install pre-commit bandit[toml] safety codespell

    - name: Cache pre-commit hooks
      run: |
        pre-commit install --install-hooks

    # ====================================================================
    # FORMATTING CHECKS
    # ====================================================================

    - name: Check code formatting with Black
      run: |
        echo "üé® Checking code formatting with Black..."
        python -m black --check --diff --color src/ tests/ run.py scripts/ || (
          echo "‚ùå Code formatting issues found. Run the following to fix:"
          echo "   black src/ tests/ run.py scripts/"
          exit 1
        )

    - name: Check import sorting with isort
      run: |
        echo "üì¶ Checking import sorting with isort..."
        python -m isort --check-only --diff --color src/ tests/ run.py || (
          echo "‚ùå Import sorting issues found. Run the following to fix:"
          echo "   isort src/ tests/ run.py"
          exit 1
        )

    # ====================================================================
    # LINTING CHECKS
    # ====================================================================

    - name: Lint with Flake8
      run: |
        echo "üîç Running Flake8 linting..."
        python -m flake8 src/ tests/ run.py --config=config/.flake8 --statistics || (
          echo "‚ùå Linting issues found. Review the output above."
          exit 1
        )

    - name: Lint shell scripts with ShellCheck
      run: |
        echo "üêö Checking shell scripts with ShellCheck..."
        find scripts/ -name "*.sh" -type f -exec shellcheck {} \; || (
          echo "‚ùå Shell script issues found. Review the output above."
          exit 1
        )

    # ====================================================================
    # TYPE CHECKING
    # ====================================================================

    - name: Type check with MyPy
      continue-on-error: ${{ matrix.python-version != '3.12' }}  # Only fail on main Python version
      run: |
        echo "üîç Running MyPy type checking..."
        python -m mypy src/ --config-file=config/mypy.ini || (
          echo "‚ö†Ô∏è MyPy found type issues. Review the output above."
          if [ "${{ matrix.python-version }}" = "3.12" ]; then
            echo "‚ùå Failing build due to type issues on main Python version"
            exit 1
          else
            echo "‚ö†Ô∏è Type issues found but not failing build (non-main Python version)"
          fi
        )

    # ====================================================================
    # SECURITY CHECKS
    # ====================================================================

    - name: Run Bandit security linter
      run: |
        echo "üõ°Ô∏è Running Bandit security analysis..."
        python -m bandit -r src/ -f txt -o bandit-results.txt --configfile pyproject.toml || (
          echo "‚ö†Ô∏è Bandit found potential security issues. Review bandit-results.txt"
          echo "Note: Some findings may be false positives in data science code"
        )

    - name: Check for known security vulnerabilities
      run: |
        echo "üîí Checking for known security vulnerabilities..."
        python -m safety check --file requirements.txt --output text || (
          echo "‚ö†Ô∏è Safety found known security vulnerabilities in dependencies"
          echo "Review the output above and consider updating dependencies"
        )

    # ====================================================================
    # CODE QUALITY METRICS
    # ====================================================================

    - name: Check code complexity
      run: |
        echo "üß© Checking code complexity..."
        python -c "
        import ast
        import os
        from radon.complexity import cc_visit

        def check_complexity(file_path):
            try:
                with open(file_path, 'r', encoding='utf-8') as f:
                    content = f.read()
                tree = ast.parse(content)
                results = cc_visit(tree)
                for result in results:
                    if result.complexity > 15:
                        print(f'‚ö†Ô∏è High complexity in {file_path}: {result.name} ({result.complexity})')
            except Exception as e:
                pass  # Skip files that can't be parsed

        for root, dirs, files in os.walk('src'):
            for file in files:
                if file.endswith('.py'):
                    check_complexity(os.path.join(root, file))
        "

    - name: Check documentation coverage
      run: |
        echo "üìö Checking documentation coverage..."
        python -c "
        import ast
        import os

        def check_docstrings(file_path):
            try:
                with open(file_path, 'r', encoding='utf-8') as f:
                    content = f.read()
                tree = ast.parse(content)
                functions = [node for node in ast.walk(tree) if isinstance(node, ast.FunctionDef)]
                classes = [node for node in ast.walk(tree) if isinstance(node, ast.ClassDef)]

                documented_functions = sum(1 for func in functions if ast.get_docstring(func))
                documented_classes = sum(1 for cls in classes if ast.get_docstring(cls))

                total_items = len(functions) + len(classes)
                documented_items = documented_functions + documented_classes

                if total_items > 0:
                    coverage = (documented_items / total_items) * 100
                    if coverage < 80:
                        print(f'‚ö†Ô∏è Low documentation coverage in {file_path}: {coverage:.1f}%')
                    else:
                        print(f'‚úÖ Good documentation coverage in {file_path}: {coverage:.1f}%')
            except Exception as e:
                pass

        for root, dirs, files in os.walk('src'):
            for file in files:
                if file.endswith('.py') and not file.startswith('test_'):
                    check_docstrings(os.path.join(root, file))
        "

    # ====================================================================
    # SPELLING & DOCUMENTATION CHECKS
    # ====================================================================

    - name: Check spelling in code and documentation
      run: |
        echo "üìù Checking spelling in code and documentation..."
        python -m codespell src/ docs/ README.md --skip='*.pyc,*.pyo,__pycache__,.git' || (
          echo "‚ö†Ô∏è Spelling issues found. Review the output above."
          echo "Note: Some technical terms may be flagged incorrectly"
        )

    # ====================================================================
    # PRE-COMMIT HOOKS
    # ====================================================================

    - name: Run pre-commit hooks
      run: |
        echo "üîß Running pre-commit hooks..."
        pre-commit run --all-files --color=always || (
          echo "‚ùå Pre-commit hooks failed. Run the following to fix:"
          echo "   pre-commit run --all-files"
          echo "   pre-commit run --all-files --fix"  # For hooks that can auto-fix
          exit 1
        )

    # ====================================================================
    # REPORTING & ARTIFACTS
    # ====================================================================

    - name: Generate quality report
      if: always()
      run: |
        echo "# Code Quality Report (Python ${{ matrix.python-version }})" > quality-report-${{ matrix.python-version }}.md
        echo "" >> quality-report-${{ matrix.python-version }}.md
        echo "## Quality Metrics" >> quality-report-${{ matrix.python-version }}.md
        echo "- **Python Version**: ${{ matrix.python-version }}" >> quality-report-${{ matrix.python-version }}.md
        echo "- **Execution Time**: $(date)" >> quality-report-${{ matrix.python-version }}.md
        echo "- **Repository**: ${{ github.repository }}" >> quality-report-${{ matrix.python-version }}.md
        echo "- **Branch**: ${{ github.ref_name }}" >> quality-report-${{ matrix.python-version }}.md
        echo "" >> quality-report-${{ matrix.python-version }}.md
        echo "## Checks Performed" >> quality-report-${{ matrix.python-version }}.md
        echo "- ‚úÖ Code formatting (Black)" >> quality-report-${{ matrix.python-version }}.md
        echo "- ‚úÖ Import sorting (isort)" >> quality-report-${{ matrix.python-version }}.md
        echo "- ‚úÖ Linting (Flake8)" >> quality-report-${{ matrix.python-version }}.md
        echo "- ‚úÖ Type checking (MyPy)" >> quality-report-${{ matrix.python-version }}.md
        echo "- ‚úÖ Security scanning (Bandit)" >> quality-report-${{ matrix.python-version }}.md
        echo "- ‚úÖ Vulnerability checking (Safety)" >> quality-report-${{ matrix.python-version }}.md
        echo "- ‚úÖ Spelling checks (codespell)" >> quality-report-${{ matrix.python-version }}.md
        echo "- ‚úÖ Pre-commit hooks" >> quality-report-${{ matrix.python-version }}.md
        echo "" >> quality-report-${{ matrix.python-version }}.md
        echo "## File Statistics" >> quality-report-${{ matrix.python-version }}.md
        echo "\`\`\`" >> quality-report-${{ matrix.python-version }}.md
        echo "Python files: $(find src/ tests/ -name '*.py' | wc -l)" >> quality-report-${{ matrix.python-version }}.md
        echo "Lines of code: $(find src/ tests/ -name '*.py' -exec wc -l {} \; | awk '{sum += $1} END {print sum}') " >> quality-report-${{ matrix.python-version }}.md
        echo "Test files: $(find tests/ -name '*.py' | wc -l)" >> quality-report-${{ matrix.python-version }}.md
        echo "\`\`\`" >> quality-report-${{ matrix.python-version }}.md

    - name: Upload quality reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: quality-reports-py${{ matrix.python-version }}
        path: |
          quality-report-*.md
          bandit-results.txt
          .mypy_cache/

  # ====================================================================
  # DEPENDENCY ANALYSIS
  # ====================================================================

  dependency-analysis:
    name: Dependency Analysis
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.12"
        cache: 'pip'

    - name: Install dependency analysis tools
      run: |
        python -m pip install --upgrade pip
        pip install pip-tools pip-audit safety bandit[toml] licensecheck

    - name: Analyze dependencies
      run: |
        echo "üì¶ Analyzing dependency tree..."
        pip install pipdeptree
        echo "## Dependency Tree" > dependency-analysis.md
        echo "\`\`\`" >> dependency-analysis.md
        pipdeptree >> dependency-analysis.md
        echo "\`\`\`" >> dependency-analysis.md

        echo "" >> dependency-analysis.md
        echo "## Outdated Packages" >> dependency-analysis.md
        echo "\`\`\`" >> dependency-analysis.md
        pip list --outdated --format=columns || echo "No outdated packages found" >> dependency-analysis.md
        echo "\`\`\`" >> dependency-analysis.md

    - name: Check licenses
      run: |
        echo "## License Compliance" >> dependency-analysis.md
        echo "\`\`\`" >> dependency-analysis.md
        licensecheck --format=markdown || echo "License check failed" >> dependency-analysis.md
        echo "\`\`\`" >> dependency-analysis.md

    - name: Audit dependencies for vulnerabilities
      run: |
        echo "## Security Audit" >> dependency-analysis.md
        echo "\`\`\`" >> dependency-analysis.md
        pip-audit --format=markdown || echo "Audit completed with warnings" >> dependency-analysis.md
        echo "\`\`\`" >> dependency-analysis.md

    - name: Upload dependency analysis
      uses: actions/upload-artifact@v4
      with:
        name: dependency-analysis
        path: dependency-analysis.md

  # ====================================================================
  # FINAL QUALITY SUMMARY
  # ====================================================================

  quality-summary:
    name: Quality Summary & Reporting
    runs-on: ubuntu-latest
    needs: [code-quality, dependency-analysis]
    if: always()

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download quality artifacts
      uses: actions/download-artifact@v4
      with:
        path: quality-artifacts/

    - name: Generate comprehensive quality report
      run: |
        echo "# Linear Regression Guide - Quality Assurance Report" > comprehensive-quality-report.md
        echo "" >> comprehensive-quality-report.md
        echo "## Executive Summary" >> comprehensive-quality-report.md
        echo "" >> comprehensive-quality-report.md
        echo "This report summarizes the code quality, security, and compliance checks performed on the Linear Regression Guide project." >> comprehensive-quality-report.md
        echo "" >> comprehensive-quality-report.md
        echo "### Report Details" >> comprehensive-quality-report.md
        echo "- **Generated**: $(date)" >> comprehensive-quality-report.md
        echo "- **Workflow**: ${{ github.workflow }}" >> comprehensive-quality-report.md
        echo "- **Repository**: ${{ github.repository }}" >> comprehensive-quality-report.md
        echo "- **Branch**: ${{ github.ref_name }}" >> comprehensive-quality-report.md
        echo "- **Commit**: ${{ github.sha }}" >> comprehensive-quality-report.md
        echo "" >> comprehensive-quality-report.md

        echo "## Quality Metrics Overview" >> comprehensive-quality-report.md
        echo "" >> comprehensive-quality-report.md
        echo "### Code Quality Checks" >> comprehensive-quality-report.md
        echo "- ‚úÖ **Formatting**: Black code formatting" >> comprehensive-quality-report.md
        echo "- ‚úÖ **Imports**: isort import sorting" >> comprehensive-quality-report.md
        echo "- ‚úÖ **Linting**: Flake8 comprehensive linting" >> comprehensive-quality-report.md
        echo "- ‚úÖ **Types**: MyPy static type checking" >> comprehensive-quality-report.md
        echo "- ‚úÖ **Security**: Bandit security analysis" >> comprehensive-quality-report.md
        echo "- ‚úÖ **Dependencies**: Safety vulnerability scanning" >> comprehensive-quality-report.md
        echo "- ‚úÖ **Spelling**: codespell documentation checking" >> comprehensive-quality-report.md
        echo "- ‚úÖ **Pre-commit**: Automated quality gates" >> comprehensive-quality-report.md
        echo "" >> comprehensive-quality-report.md

        echo "### Test Coverage" >> comprehensive-quality-report.md
        echo "- **Unit Tests**: Individual function testing" >> comprehensive-quality-report.md
        echo "- **Integration Tests**: Component interaction testing" >> comprehensive-quality-report.md
        echo "- **Performance Tests**: Speed and resource testing" >> comprehensive-quality-report.md
        echo "- **Property Tests**: Hypothesis-based edge case testing" >> comprehensive-quality-report.md
        echo "- **Visual Tests**: Plot generation consistency" >> comprehensive-quality-report.md
        echo "" >> comprehensive-quality-report.md

        echo "## Job Status Summary" >> comprehensive-quality-report.md
        echo "" >> comprehensive-quality-report.md
        echo "### CI/CD Pipeline Results" >> comprehensive-quality-report.md
        echo "- **Code Quality**: ${{ needs.code-quality.result }}" >> comprehensive-quality-report.md
        echo "- **Dependency Analysis**: ${{ needs.dependency-analysis.result }}" >> comprehensive-quality-report.md
        echo "" >> comprehensive-quality-report.md

        # Overall assessment
        if [ "${{ needs.code-quality.result }}" = "success" ] && [ "${{ needs.dependency-analysis.result }}" != "failure" ]; then
            echo "## üéâ Quality Assessment: PASSED" >> comprehensive-quality-report.md
            echo "" >> comprehensive-quality-report.md
            echo "All quality checks have passed successfully. The codebase meets professional standards and is ready for deployment." >> comprehensive-quality-report.md
            echo "" >> comprehensive-quality-report.md
            echo "### Next Steps" >> comprehensive-quality-report.md
            echo "1. Review any informational warnings in the detailed reports" >> comprehensive-quality-report.md
            echo "2. Address any dependency update recommendations" >> comprehensive-quality-report.md
            echo "3. Proceed with deployment or merge to main branch" >> comprehensive-quality-report.md
        else
            echo "## ‚ùå Quality Assessment: ISSUES FOUND" >> comprehensive-quality-report.md
            echo "" >> comprehensive-quality-report.md
            echo "Some quality checks have failed. Please review the individual job logs and fix any issues before proceeding." >> comprehensive-quality-report.md
            echo "" >> comprehensive-quality-report.md
            echo "### Required Actions" >> comprehensive-quality-report.md
            echo "1. Fix any failing code quality checks" >> comprehensive-quality-report.md
            echo "2. Address security vulnerabilities if found" >> comprehensive-quality-report.md
            echo "3. Re-run the quality checks until they pass" >> comprehensive-quality-report.md
        fi

        echo "" >> comprehensive-quality-report.md
        echo "---" >> comprehensive-quality-report.md
        echo "*This report was automatically generated by GitHub Actions*" >> comprehensive-quality-report.md

    - name: Upload comprehensive quality report
      uses: actions/upload-artifact@v4
      with:
        name: comprehensive-quality-report
        path: comprehensive-quality-report.md

    - name: Quality check completion notification
      if: always()
      run: |
        if [ "${{ needs.code-quality.result }}" = "success" ]; then
          echo "üéâ All quality checks passed! The codebase meets professional standards."
        else
          echo "‚ö†Ô∏è Some quality checks failed. Please review the detailed reports and fix any issues."
        fi
