name: Documentation Deployment

on:
  push:
    branches: [ master, main ]
    paths:
      - 'docs/**'
      - 'README.md'
      - 'scripts/generate_docs.sh'
  workflow_dispatch:
    inputs:
      deploy_target:
        description: 'Documentation deployment target'
        required: true
        default: 'github-pages'
        type: choice
        options:
          - github-pages
          - external-docs
          - pdf-export
      version:
        description: 'Documentation version (leave empty for latest)'
        required: false
        type: string

env:
  PYTHONUNBUFFERED: 1

jobs:
  # ====================================================================
  # DOCUMENTATION GENERATION
  # ====================================================================

  generate-docs:
    name: Generate Documentation
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.12"

    - name: Install documentation dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pdoc mkdocs mkdocs-material mkdocs-pdf-export-plugin

    - name: Generate API documentation
      run: |
        echo "ğŸ“š Generating API documentation..."
        ./scripts/generate_docs.sh --api-only

    - name: Generate project statistics
      run: |
        echo "ğŸ“Š Generating project statistics..."
        ./scripts/generate_docs.sh --readme-only

    - name: Generate comprehensive docs
      run: |
        echo "ğŸ“– Generating comprehensive documentation..."
        ./scripts/generate_docs.sh

    - name: Validate documentation links
      run: |
        echo "ğŸ”— Validating documentation links..."
        python -c "
        import os
        import re

        def check_links(file_path):
            try:
                with open(file_path, 'r', encoding='utf-8') as f:
                    content = f.read()
                
                # Find markdown links
                links = re.findall(r'\[([^\]]+)\]\(([^)]+)\)', content)
                broken_links = []
                
                for text, url in links:
                    # Skip external links and anchors
                    if url.startswith(('http', 'https', '#', 'mailto:')):
                        continue
                    
                    # Check relative links
                    full_path = os.path.join(os.path.dirname(file_path), url.split('#')[0])
                    if not os.path.exists(full_path):
                        broken_links.append(url)
                
                return broken_links
            except Exception as e:
                return [f'Error reading file: {e}']

        # Check all docs
        all_broken = []
        for root, dirs, files in os.walk('docs'):
            for file in files:
                if file.endswith('.md'):
                    file_path = os.path.join(root, file)
                    broken = check_links(file_path)
                    if broken:
                        all_broken.extend([f'{file_path}: {link}' for link in broken])

        if all_broken:
            print('âŒ Broken documentation links found:')
            for link in all_broken:
                print(f'  {link}')
            exit(1)
        else:
            print('âœ… All documentation links are valid')
        "

    - name: Upload generated documentation
      uses: actions/upload-artifact@v4
      with:
        name: generated-docs
        path: |
          docs/
          !docs/**/*.tmp

  # ====================================================================
  # GITHUB PAGES DEPLOYMENT
  # ====================================================================

  deploy-github-pages:
    name: Deploy to GitHub Pages
    runs-on: ubuntu-latest
    needs: generate-docs
    if: github.event.inputs.deploy_target == 'github-pages' || (github.event_name == 'push' && github.ref == 'refs/heads/main')

    permissions:
      contents: read
      pages: write
      id-token: write

    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download generated documentation
      uses: actions/download-artifact@v4
      with:
        name: generated-docs
        path: docs/

    - name: Setup Pages
      uses: actions/configure-pages@v4

    - name: Build with MkDocs
      run: |
        # Create mkdocs.yml if it doesn't exist
        if [ ! -f "mkdocs.yml" ]; then
          cat > mkdocs.yml << 'EOF'
        site_name: Linear Regression Guide
        site_description: Interactive web app for learning linear regression
        site_author: Luca Hagenmayer

        theme:
          name: material
          palette:
            primary: blue
            accent: blue
          features:
            - navigation.tabs
            - navigation.sections
            - toc.integrate
            - search.suggest
            - search.highlight

        plugins:
          - search
          - pdf-export:
              combined: true
              media_type: print

        markdown_extensions:
          - pymdownx.highlight
          - pymdownx.superfences
          - pymdownx.inlinehilite
          - pymdownx.arithmatex
          - pymdownx.details
          - pymdownx.tabbed
          - toc:
              permalink: true

        nav:
          - Home: README.md
          - Documentation: docs/INDEX.md
          - API Reference: docs/api/src.html
      EOF
        fi

        # Build docs site
        mkdocs build --clean

    - name: Upload artifact for Pages
      uses: actions/upload-pages-artifact@v3
      with:
        path: site/

    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4

  # ====================================================================
  # EXTERNAL DOCUMENTATION DEPLOYMENT
  # ====================================================================

  deploy-external:
    name: Deploy to External Documentation Site
    runs-on: ubuntu-latest
    needs: generate-docs
    if: github.event.inputs.deploy_target == 'external-docs'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download generated documentation
      uses: actions/download-artifact@v4
      with:
        name: generated-docs
        path: docs/

    - name: Deploy to external docs site
      run: |
        echo "ğŸ“¤ Deploying to external documentation site..."
        echo "Note: This is a placeholder for external deployment"
        echo "Configure your deployment method here (Netlify, Vercel, etc.)"
        echo ""

        # Example for Netlify deployment
        echo "Example Netlify deployment:"
        echo "1. Install Netlify CLI: npm install -g netlify-cli"
        echo "2. Deploy: netlify deploy --dir=docs --prod"
        echo ""

        # List generated files
        echo "Generated documentation files:"
        find docs/ -type f -name "*.md" -o -name "*.html" | head -20

  # ====================================================================
  # PDF EXPORT GENERATION
  # ====================================================================

  generate-pdf:
    name: Generate PDF Documentation
    runs-on: ubuntu-latest
    needs: generate-docs
    if: github.event.inputs.deploy_target == 'pdf-export'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download generated documentation
      uses: actions/download-artifact@v4
      with:
        name: generated-docs
        path: docs/

    - name: Set up Node.js for PDF generation
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Install PDF generation tools
      run: |
        npm install -g markdown-pdf
        npm install -g @mermaid-js/mermaid-cli

    - name: Generate PDF documentation
      run: |
        echo "ğŸ“„ Generating PDF documentation..."

        # Convert main docs to PDF
        markdown-pdf docs/README.md -o documentation.pdf
        markdown-pdf docs/DEVELOPMENT.md -o development-guide.pdf
        markdown-pdf docs/TESTING.md -o testing-guide.pdf

        # Combine all docs into single PDF
        echo "Combining all documentation..."
        # This would require additional tooling like pdftk or similar

        echo "PDF generation completed"

    - name: Upload PDF artifacts
      uses: actions/upload-artifact@v4
      with:
        name: documentation-pdfs
        path: |
          *.pdf

  # ====================================================================
  # DOCUMENTATION STATUS REPORT
  # ====================================================================

  docs-status-report:
    name: Documentation Status Report
    runs-on: ubuntu-latest
    needs: [generate-docs, deploy-github-pages, deploy-external, generate-pdf]
    if: always()

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download docs artifacts
      uses: actions/download-artifact@v4
      with:
        path: docs-artifacts/

    - name: Generate documentation status report
      run: |
        echo "# ğŸ“š Documentation Status Report" > docs-status-report.md
        echo "" >> docs-status-report.md
        echo "## Deployment Summary" >> docs-status-report.md
        echo "- **Date**: $(date)" >> docs-status-report.md
        echo "- **Workflow**: ${{ github.workflow }}" >> docs-status-report.md
        echo "- **Target**: ${{ github.event.inputs.deploy_target || 'auto (GitHub Pages)' }}" >> docs-status-report.md
        echo "" >> docs-status-report.md

        echo "## Deployment Results" >> docs-status-report.md
        echo "" >> docs-status-report.md
        echo "### Generation Phase" >> docs-status-report.md
        echo "- **API Docs**: ${{ needs.generate-docs.result }}" >> docs-status-report.md
        echo "- **Statistics**: Generated" >> docs-status-report.md
        echo "- **Link Validation**: âœ… Passed" >> docs-status-report.md
        echo "" >> docs-status-report.md

        echo "### Deployment Phase" >> docs-status-report.md
        if [[ "${{ github.event.inputs.deploy_target }}" == "github-pages" ]] || [[ "${{ github.event_name }}" == "push" ]]; then
          echo "- **GitHub Pages**: ${{ needs.deploy-github-pages.result }}" >> docs-status-report.md
        fi
        if [[ "${{ github.event.inputs.deploy_target }}" == "external-docs" ]]; then
          echo "- **External Docs**: ${{ needs.deploy-external.result }}" >> docs-status-report.md
        fi
        if [[ "${{ github.event.inputs.deploy_target }}" == "pdf-export" ]]; then
          echo "- **PDF Export**: ${{ needs.generate-pdf.result }}" >> docs-status-report.md
        fi
        echo "" >> docs-status-report.md

        echo "## Generated Documentation" >> docs-status-report.md
        echo "" >> docs-status-report.md

        if [[ -d "docs-artifacts/generated-docs/docs" ]]; then
          echo "### Files Generated" >> docs-status-report.md
          find docs-artifacts/generated-docs/docs -name "*.md" -o -name "*.html" | wc -l | xargs echo "- Markdown files:" >> docs-status-report.md
          find docs-artifacts/generated-docs/docs -name "*.html" | wc -l | xargs echo "- HTML files:" >> docs-status-report.md
          echo "" >> docs-status-report.md

          echo "### Documentation Structure" >> docs-status-report.md
          echo "\`\`\`" >> docs-status-report.md
          find docs-artifacts/generated-docs/docs -type f -name "*.md" | head -20 >> docs-status-report.md
          echo "\`\`\`" >> docs-status-report.md
        fi

        echo "## Next Steps" >> docs-status-report.md
        echo "" >> docs-status-report.md
        if [[ "${{ needs.deploy-github-pages.result }}" == "success" ]]; then
          echo "âœ… **Documentation deployed successfully to GitHub Pages**" >> docs-status-report.md
          echo "- Access at: https://YOUR_USERNAME.github.io/linear-regression-guide" >> docs-status-report.md
        else
          echo "ğŸ“ **Documentation generated but not deployed**" >> docs-status-report.md
          echo "- Download artifacts from this workflow run" >> docs-status-report.md
          echo "- Manually deploy to your preferred platform" >> docs-status-report.md
        fi

        echo "" >> docs-status-report.md
        echo "---" >> docs-status-report.md
        echo "*This report was automatically generated by the documentation deployment workflow*" >> docs-status-report.md

    - name: Upload documentation status report
      uses: actions/upload-artifact@v4
      with:
        name: docs-status-report
        path: docs-status-report.md

    - name: Documentation deployment completion
      if: always()
      run: |
        echo "ğŸ“š Documentation deployment completed!"

        if [[ "${{ needs.generate-docs.result }}" == "success" ]]; then
          echo "âœ… Documentation generation: SUCCESS"
        else
          echo "âŒ Documentation generation: FAILED"
        fi

        if [[ "${{ needs.deploy-github-pages.result }}" == "success" ]]; then
          echo "âœ… GitHub Pages deployment: SUCCESS"
          echo "ğŸ”— Access documentation at: https://YOUR_USERNAME.github.io/linear-regression-guide"
        elif [[ "${{ github.event.inputs.deploy_target }}" == "github-pages" ]]; then
          echo "âŒ GitHub Pages deployment: FAILED"
        fi

        echo ""
        echo "ğŸ“‹ Check the artifacts for detailed reports and generated documentation."