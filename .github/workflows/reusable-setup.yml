# Reusable workflow for setting up the development environment
# This workflow can be called by other workflows to ensure consistent setup

name: Setup Environment

on:
  workflow_call:
    inputs:
      python-version:
        description: 'Python version to use'
        required: false
        default: '3.12'
        type: string
      install-dev-deps:
        description: 'Install development dependencies'
        required: false
        default: true
        type: boolean
      cache-dependencies:
        description: 'Cache pip dependencies'
        required: false
        default: true
        type: boolean

env:
  PYTHONUNBUFFERED: 1
  PYTHONDONTWRITEBYTECODE: 1

jobs:
  setup:
    name: Environment Setup
    runs-on: ubuntu-latest
    outputs:
      python-version: ${{ inputs.python-version }}
      cache-hit: ${{ steps.cache-deps.outputs.cache-hit }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 1  # Shallow clone for faster setup

    - name: Set up Python ${{ inputs.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ inputs.python-version }}
        cache: ${{ inputs.cache-dependencies && 'pip' || '' }}
        cache-dependency-path: |
          requirements*.txt
          pyproject.toml

    - name: Cache pip dependencies
      id: cache-deps
      if: inputs.cache-dependencies
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ inputs.python-version }}-${{ hashFiles('requirements*.txt', 'pyproject.toml') }}
        restore-keys: |
          ${{ runner.os }}-pip-${{ inputs.python-version }}-
          ${{ runner.os }}-pip-

    - name: Install system dependencies
      run: |
        sudo apt-get update -qq
        sudo apt-get install -y -qq graphviz shellcheck

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip setuptools wheel

        # Always install production dependencies
        pip install -r requirements.txt

        # Install development dependencies if requested
        if [[ "${{ inputs.install-dev-deps }}" == "true" ]]; then
          pip install -r requirements-dev.txt
        fi

    - name: Verify installation
      run: |
        echo "üîç Verifying installation..."

        # Check Python imports
        python -c "
        import sys
        sys.path.insert(0, 'src')
        import streamlit as st
        import numpy as np
        import pandas as pd
        import plotly.graph_objects as go
        print('‚úÖ Core dependencies imported successfully')
        "

        # Check development tools if installed
        if [[ "${{ inputs.install-dev-deps }}" == "true" ]]; then
          python -c "
          import black, flake8, mypy, pytest
          print('‚úÖ Development tools imported successfully')
          " 2>/dev/null || echo "‚ö†Ô∏è Some development tools not available"
        fi

        echo "‚úÖ Environment setup completed"